<!DOCTYPE html>
<html lang="ca">

<head>
    <meta charset="UTF-8">
    <title>Cercador de versets – Bíblia BEC</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 2rem;
            max-width: 820px;
            line-height: 1.45
        }

        h1 {
            font-size: 2rem;
            margin-top: 0
        }

        textarea {
            width: 100%;
            height: 6rem;
            padding: 0.5rem;
            font-size: 1rem
        }

        button {
            padding: 0.5rem 1rem;
            font-size: 1rem;
            margin-top: 0.5rem;
            cursor: pointer
        }

        #resultats {
            margin-top: 2rem;
            white-space: pre-wrap
        }

        .bloc {
            margin-bottom: 1.2rem
        }

        .titol {
            font-weight: bold;
            text-transform: uppercase
        }

        .error {
            color: #b00;
            margin: 0.25rem 0
        }

        details {
            margin-bottom: 1rem
        }

        summary {
            cursor: pointer;
            font-weight: bold;
            margin-bottom: 0.25rem
        }
    </style>
</head>

<body>
    <h1>Cercador de versets – Bíblia BEC</h1>

    <!-- ───────────────── Ajuda plegable ───────────────── -->
    <details>
        <summary>Com escriure cites (fes clic per mostrar exemples)</summary>
        <p style="margin-top:0.5rem;">Escriu cites separades per comes o bé cada una en línia/bullets. Pots afegir els
            teus àlies al bloc JSON que hi ha a sota.</p>
        <pre style="margin-top:-0.5rem;">
Mateu 23:23-29, 1 Timoteu 1:8-10, Colossencs 2:14,16-17

Mateu 23:23-29
1 Timoteu 1:8-10
Colossencs 2:14,16-17

- Mateu 23:23-29
- 1 Timoteu 1:8-10
- Colossencs 2:14,16-17
  </pre>
    </details>

    <textarea id="input" placeholder="Ex: Mateu 23:23-29, 1 Timoteu 1:8-10"></textarea>
    <br>
    <button id="cerca">Cerca</button>
    <div id="carregant" style="display:none; margin-top:1rem;">Carregant Bíblia…</div>
    <div id="resultats"></div>

    <!-- ───────────── Àlies editables en JSON ───────────── -->
    <script id="aliasData" type="application/json">
{
  "genesis"   : "Gènesi",
  "genesís"   : "Gènesi",
  "2 cron"    : "2a Cròniques",
  "2 cron 31" : "2a Cròniques"  
}
</script>

    <script>
        (async () => {
            const inputEl = document.getElementById('input');
            const btn = document.getElementById('cerca');
            const loading = document.getElementById('carregant');
            const outDiv = document.getElementById('resultats');

            // ────────────────────────────────────────
            // Utilitats
            const normalize = str => (str || '')
                .normalize('NFD')
                .replace(/\p{Diacritic}/gu, '')
                .toLowerCase()
                .replace(/[^a-z0-9 ]/g, ' ')
                .replace(/\s+/g, ' ')
                .trim();

            // Sinònims manuals (provenen del bloc JSON editable)
            let customAliases = {};
            try {
                customAliases = JSON.parse(document.getElementById('aliasData').textContent);
            } catch (e) { console.warn('Alias JSON malformat'); }

            // ────────────────────────────────────────
            // Carregar XML
            loading.style.display = 'block';
            let xmlDoc;
            try {
                const res = await fetch('IBEX_Biliba.xml');
                const txt = await res.text();
                xmlDoc = new DOMParser().parseFromString(txt, 'application/xml');
            } catch (e) {
                loading.textContent = 'No s’ha pogut carregar l’arxiu XML';
                throw e;
            }

            // Indexar
            const llibreNodes = Array.from(xmlDoc.getElementsByTagName('libro'));
            const index = {};   // { bookKey: { capNum: [versNodes] } }
            const aliasMap = {};// variant normalitzada => bookKey

            llibreNodes.forEach(lib => {
                const titleNode = lib.getElementsByTagName('titulo')[0];
                if (!titleNode) return;
                const canon = titleNode.textContent.trim();
                const bookKey = normalize(canon);
                index[bookKey] = {};
                aliasMap[bookKey] = bookKey;

                // Capítols (un <capitulo> per vers)
                Array.from(lib.getElementsByTagName('capitulo')).forEach(cap => {
                    const capNum = parseInt(cap.getElementsByTagName('num_capitulo')[0].textContent, 10);
                    if (!index[bookKey][capNum]) index[bookKey][capNum] = [];
                    index[bookKey][capNum].push(...cap.getElementsByTagName('versiculo'));
                });

                // Aliases automàtics 1a/2a/3a
                const m = canon.match(/^([1-3])a?\s+(.+)$/i);
                if (m) {
                    const num = m[1];
                    const rest = normalize(m[2]);
                    [`${num} ${rest}`, `${num}${rest}`, `${['primer', 'segon', 'tercer'][num - 1]} ${rest}`]
                        .forEach(a => aliasMap[normalize(a)] = bookKey);
                    if (!aliasMap[rest]) aliasMap[rest] = bookKey;
                }
            });

            // Aliases definits per l’usuari
            Object.entries(customAliases).forEach(([k, v]) => {
                aliasMap[normalize(k)] = normalize(v);
            });

            loading.style.display = 'none';

            // ────────────────────────────────────────
            // Cerca
            btn.addEventListener('click', () => process());
            inputEl.addEventListener('keydown', e => { if (e.key === 'Enter' && (e.ctrlKey || e.metaKey)) { process(); } });

            function process() {
                outDiv.innerHTML = '';
                const raw = inputEl.value.trim();
                if (!raw) { return; }

                // 1️⃣ Separem per línies, netejant bullets i puntuació final
                const lines = raw.split(/\n+/).map(l =>
                    l.replace(/^\s*[-•*] ?/, '')   // treu guió o bullet
                        .replace(/[.,;·]+$/, '')       // treu puntuació final
                        .trim()
                ).filter(Boolean);

                // 2️⃣ A cada línia, separem per ", " (coma + espais)
                const refs = [];
                lines.forEach(line => {
                    line.split(/,\s+/).forEach(r => { const t = r.trim(); if (t) refs.push(t); });
                });

                const errors = [];

                refs.forEach(ref => {
                    const m = ref.match(/^(.+?)\s+(\d+):(\d+(?:[-–]\d+)?(?:,\d+(?:[-–]\d+)?)*)$/);
                    if (!m) { errors.push(`Format invàlid: ${ref}`); return; }
                    let [, bookRaw, capStr, versSpec] = m;
                    const bookKey = aliasMap[normalize(bookRaw)];
                    if (!bookKey) { errors.push(`Llibre no trobat: ${bookRaw}`); return; }
                    const cap = parseInt(capStr, 10);
                    const capData = index[bookKey][cap];
                    if (!capData) { errors.push(`Capítol no trobat: ${bookRaw} ${cap}`); return; }

                    // Expandeix versSpec
                    const targets = [];
                    versSpec.split(',').forEach(chunk => {
                        if (/[-–]/.test(chunk)) {
                            const [s, e] = chunk.split(/[-–]/).map(v => parseInt(v, 10));
                            for (let v = s; v <= e; v++) targets.push(v);
                        } else {
                            targets.push(parseInt(chunk, 10));
                        }
                    });

                    const versesNodes = capData.filter(v => targets.includes(parseInt(v.getElementsByTagName('num_versiculo')[0].textContent, 10)));
                    if (!versesNodes.length) { errors.push(`Versos no trobats: ${ref}`); return; }

                    // Bloc
                    const bloc = document.createElement('div');
                    bloc.className = 'bloc';
                    const tit = document.createElement('div');
                    tit.className = 'titol';
                    tit.textContent = `${bookRaw.toUpperCase()} ${cap}:${versSpec}`;
                    bloc.appendChild(tit);
                    const text = versesNodes.map(v => v.getElementsByTagName('texto_versiculo')[0].textContent.trim()).join(' ');
                    bloc.appendChild(document.createTextNode(text));
                    outDiv.appendChild(bloc);
                });

                // Errors
                errors.forEach(er => {
                    const d = document.createElement('div');
                    d.className = 'error';
                    d.textContent = er;
                    outDiv.appendChild(d);
                });
            }
        })();
    </script>
</body>

</html>